{% extends 'base.html' %}

{% block title %}Nova Venda (PDV){% endblock %}

{% block content %}
<style>
    .pos-container {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 20px;
        height: calc(100vh - 100px);
    }
    .menu-section {
        overflow-y: auto;
        padding-right: 10px;
    }
    .cart-section {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .cart-items {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    .cart-form {
        padding: 15px;
        background: #f9f9f9;
        border-radius: 0 0 8px 8px;
    }
    .item-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: transform 0.1s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .item-card:hover {
        transform: scale(1.01);
        border-color: #007bff;
    }
    .category-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin: 15px 0 10px 0;
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
    }
    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
    }
    .remove-btn {
        color: red;
        cursor: pointer;
        margin-left: 10px;
        font-weight: bold;
    }
    .total-row {
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 2px solid #ddd;
    }
    .form-group { margin-bottom: 10px; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 3px; }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; text-transform: uppercase;
    }
    .submit-btn {
        width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1.1rem;
    }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .close-modal { cursor: pointer; font-size: 1.5rem; }

    /* Estilos do Acorde√£o (Categorias Expans√≠veis) */
    .accordion-btn {
        width: 100%; padding: 15px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;
        text-align: left; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-bottom: 5px;
        display: flex; justify-content: space-between; align-items: center; color: #333;
    }
    .accordion-btn:hover { background-color: #e2e6ea; }
    .accordion-content {
        display: none; padding: 10px 5px; border-left: 4px solid #007bff; margin-bottom: 10px; background-color: #fff;
    }
    .accordion-content.show { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<h2>Nova Venda (PDV)</h2>

<div class="pos-container">
    <!-- Coluna Esquerda: Card√°pio -->
    <div class="menu-section">
        {% if combos %}
            <button class="accordion-btn" onclick="toggleAccordion(this)">üî• Combos <span>‚ñº</span></button>
            <div class="accordion-content">
                {% for combo in combos %}
                    <div class="item-card" onclick="openComboModal('{{ combo.id }}')">
                        <div>
                            <strong>{{ combo.name }}</strong><br>
                            <small>{{ combo.description|truncatechars:50 }}</small>
                        </div>
                        <div style="color: #28a745; font-weight: bold;">R$ {{ combo.price|floatformat:2 }}</div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% regroup menu_items by category as category_list %}
        {% for category in category_list %}
            <button class="accordion-btn" onclick="toggleAccordion(this)">{{ category.grouper.name }} <span>‚ñº</span></button>
            <div class="accordion-content">
                {% for item in category.list %}
                    <div class="item-card" onclick="checkItemOptions('{{ item.id }}')">
                        <div>
                            <strong>{{ item.name }}</strong><br>
                            <small>{{ item.description|truncatechars:50 }}</small>
                        </div>
                        <div style="color: #28a745; font-weight: bold;">R$ {{ item.price|floatformat:2 }}</div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>

    <!-- Coluna Direita: Carrinho e Formul√°rio -->
    <div class="cart-section">
        <div class="cart-items" id="cart-list">
            <p style="text-align: center; color: #888; margin-top: 20px;">Carrinho vazio</p>
        </div>
        
        <div class="cart-form">
            <form method="post" id="pos-form">
                {% csrf_token %}
                <input type="hidden" name="cart_data" id="cart-data-input">
                
                <div class="form-group">
                    <label>Cliente</label>
                    {{ form.customer_name }}
                </div>
                <div class="form-group">
                    <label>WhatsApp</label>
                    {{ form.customer_whatsapp }}
                </div>
                <div class="form-group">
                    <label>Endere√ßo</label>
                    {{ form.delivery_address }}
                </div>
                <div class="form-group">
                    <label>Bairro (Taxa)</label>
                    {{ form.delivery_zone }}
                </div>
                <div class="form-group">
                    <label>Pagamento</label>
                    {{ form.payment_method }}
                </div>
                <div class="form-group">
                    <label>Obs</label>
                    {{ form.observations }}
                </div>

                <div class="total-row">
                    <span>Total Final:</span>
                    <span id="final-total">R$ 0.00</span>
                </div>
                
                <button type="submit" class="submit-btn" style="margin-top: 15px;">Finalizar Venda</button>
            </form>
        </div>
    </div>
</div>

<!-- Modais (Reutilizados/Adaptados) -->
<div id="comboModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Combo</h3><span class="close-modal" onclick="closeModal('comboModal')">&times;</span></div>
        <div id="comboModalBody"></div>
        <button onclick="addComboToCart()" class="submit-btn" style="margin-top: 10px;">Adicionar</button>
    </div>
</div>

<div id="itemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3 id="itemModalTitle">Opcionais</h3><span class="close-modal" onclick="closeModal('itemModal')">&times;</span></div>
        <div id="itemModalBody"></div>
        <button onclick="addItemToCart()" class="submit-btn" style="margin-top: 10px;">Adicionar</button>
    </div>
</div>

<script>
    // Dados do Backend
    const itemsData = {{ items_json|safe }};
    const combosData = {{ combos_json|safe }};
    const optsData = {{ opts_json|safe }};
    const zonesData = {{ zones_json|safe }};

    let cart = [];
    let currentComboId = null;
    let currentItemId = null;

    // Fun√ß√µes de Carrinho
    function renderCart() {
        const list = document.getElementById('cart-list');
        const zoneId = document.getElementById('id_delivery_zone').value;
        const deliveryFee = zoneId ? (zonesData[zoneId] || 0) : 0;
        
        list.innerHTML = '';
        let itemsTotal = 0;

        cart.forEach((item, index) => {
            itemsTotal += item.price * item.quantity;
            
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
                <div>
                    <strong>${item.quantity}x ${item.name}</strong><br>
                    <small>R$ ${(item.price * item.quantity).toFixed(2)}</small>
                </div>
                <span class="remove-btn" onclick="removeFromCart(${index})">‚úñ</span>
            `;
            list.appendChild(div);
        });

        if (cart.length === 0) list.innerHTML = '<p style="text-align: center; color: #888; margin-top: 20px;">Carrinho vazio</p>';

        const finalTotal = itemsTotal + deliveryFee;
        document.getElementById('final-total').textContent = `R$ ${finalTotal.toFixed(2)}`;
        document.getElementById('cart-data-input').value = JSON.stringify(cart);
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // L√≥gica de Itens
    function checkItemOptions(itemId) {
        const item = itemsData.find(i => i.id == itemId);
        const availableOpts = optsData.filter(o => o.category_id == item.category_id);

        if (availableOpts.length > 0) {
            currentItemId = itemId;
            document.getElementById('itemModalTitle').textContent = item.name;
            const body = document.getElementById('itemModalBody');
            body.innerHTML = '';
            availableOpts.forEach(opt => {
                body.innerHTML += `
                    <label style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span><input type="checkbox" class="opt-check" value="${opt.id}" data-price="${opt.price}" data-name="${opt.name}"> ${opt.name}</span>
                        <span>+R$ ${parseFloat(opt.price).toFixed(2)}</span>
                    </label>`;
            });
            document.getElementById('itemModal').style.display = 'flex';
        } else {
            // Adiciona direto
            cart.push({
                type: 'item', id: item.id, name: item.name, price: parseFloat(item.price), quantity: 1, optionals: []
            });
            renderCart();
        }
    }

    function addItemToCart() {
        const item = itemsData.find(i => i.id == currentItemId);
        const checks = document.querySelectorAll('.opt-check:checked');
        let optIds = [];
        let optNames = [];
        let extraPrice = 0;

        checks.forEach(c => {
            optIds.push(c.value);
            optNames.push(c.dataset.name);
            extraPrice += parseFloat(c.dataset.price);
        });

        let fullName = item.name;
        if (optNames.length > 0) fullName += ` (${optNames.join(', ')})`;

        cart.push({
            type: 'item', id: item.id, name: fullName, price: parseFloat(item.price) + extraPrice, quantity: 1, optionals: optIds
        });
        
        closeModal('itemModal');
        renderCart();
    }

    // L√≥gica de Combos
    function openComboModal(comboId) {
        const combo = combosData.find(c => c.id == comboId);
        currentComboId = comboId;
        const body = document.getElementById('comboModalBody');
        body.innerHTML = '';

        combo.slots.forEach(slot => {
            const items = itemsData.filter(i => i.category_id == slot.allowed_category.id);
            let optionsHtml = items.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            
            body.innerHTML += `
                <div style="margin-bottom:10px;">
                    <label>Escolha: ${slot.allowed_category.name}</label>
                    <select class="combo-select" style="width:100%; padding:8px;">${optionsHtml}</select>
                </div>`;
        });
        document.getElementById('comboModal').style.display = 'flex';
    }

    function addComboToCart() {
        const combo = combosData.find(c => c.id == currentComboId);
        const selects = document.querySelectorAll('.combo-select');
        let choiceIds = [];
        let choiceNames = [];

        selects.forEach(s => {
            choiceIds.push(s.value);
            choiceNames.push(s.options[s.selectedIndex].text);
        });

        cart.push({
            type: 'combo', id: combo.id, name: `${combo.name} (${choiceNames.join(', ')})`, price: parseFloat(combo.price), quantity: 1, choices: choiceIds
        });

        closeModal('comboModal');
        renderCart();
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // Atualiza total ao mudar bairro
    document.getElementById('id_delivery_zone').addEventListener('change', renderCart);

    // L√≥gica do Acorde√£o
    function toggleAccordion(btn) {
        const content = btn.nextElementSibling;
        content.classList.toggle('show');
        const icon = btn.querySelector('span');
        icon.textContent = content.classList.contains('show') ? '‚ñ≤' : '‚ñº';
    }

    // Converte o texto dos inputs para mai√∫sculo enquanto o usu√°rio digita
    const inputs = document.querySelectorAll('input[type="text"], input[type="tel"], textarea');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.toUpperCase();
            this.setSelectionRange(start, end);
        });
    });
</script>
{% endblock %}