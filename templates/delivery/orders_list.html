{% extends 'base.html' %}
{% load static %}

{% block title %}Pedidos Recebidos{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
    .orders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .order-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .order-id {
        font-weight: 700;
        font-size: 1.1rem;
        color: #333;
    }

    .order-status {
        font-size: 0.9rem;
        padding: 3px 8px;
        background-color: #e2e6ea;
        border-radius: 4px;
    }

    .customer-info {
        margin-bottom: 15px;
        font-size: 0.9rem;
        color: #555;
    }

    .customer-info p {
        margin: 3px 0;
    }

    .order-items {
        list-style: none;
        padding: 0;
        margin: 0 0 15px 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .order-items li {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.95rem;
    }

    .order-total {
        font-weight: 700;
        font-size: 1.1rem;
        text-align: right;
        color: #28a745;
        margin-bottom: 15px;
    }

    .actions {
        display: flex;
        gap: 10px;
        margin-top: auto;
    }

    .btn {
        flex: 1;
        padding: 10px;
        text-align: center;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
        border: none;
        font-size: 0.9rem;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .btn-whatsapp {
        background-color: #25D366;
        color: white;
    }

    .btn-print {
        background-color: #333;
        color: white;
    }

    .btn-delivery {
        background-color: #007bff;
        color: white;
    }

    .btn-delete {
        background-color: #dc3545;
        color: white;
    }

    .btn:hover {
        opacity: 0.9;
    }

    /* √Årea oculta usada apenas para gerar o cupom de impress√£o */
    .printable-ticket {
        display: none;
    }

    /* Estilo para novos pedidos (destaque escuro) */
    .order-card.new-order {
        background-color: #dcdcdc;
        /* Fundo cinza para destacar */
        border: 2px solid #888;
    }
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin: 0;">Pedidos Recebidos</h2>
    <form method="get">
        <select name="filter_date" onchange="this.form.submit()"
            style="padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; background-color: #fff; cursor: pointer;">
            <option value="today" {% if filter_date == 'today' %}selected{% endif %}>üìÖ Hoje</option>
            <option value="yesterday" {% if filter_date == 'yesterday' %}selected{% endif %}>‚èÆÔ∏è Ontem</option>
            <option value="week" {% if filter_date == 'week' %}selected{% endif %}>üìÖ √öltimos 7 dias</option>
            <option value="all" {% if filter_date == 'all' %}selected{% endif %}>üìÇ Todos</option>
        </select>
    </form>
</div>

<div id="orders-container">
    {% if not orders %}
    <div style="padding: 40px; text-align: center; background: #fff; border-radius: 8px;">
        <p>Nenhum pedido recebido ainda.</p>
    </div>
    {% else %}
    <div class="orders-grid">
        {% for order in orders %}
        <div class="order-card" data-order-id="{{ order.id }}">
            <div class="order-header">
                <span class="order-id">#{{ order.id }}</span>
                <span class="order-status">{{ order.created_at|date:"d/m H:i" }}</span>
            </div>

            <div class="customer-info">
                <p><strong>{{ order.customer_name }}</strong></p>
                <p>üìû {{ order.customer_whatsapp }}</p>
                <p>üìç {{ order.delivery_address }}</p>
                <p>üèòÔ∏è {{ order.delivery_zone.neighborhood }}</p>
                {% if order.observations %}
                <p style="color: #c9302c; margin-top: 5px;">‚ö† Obs: {{ order.observations }}</p>
                {% endif %}
            </div>

            <ul class="order-items">
                {% for item in order.items.all %}
                <li>
                    <span>{{ item.quantity }}x {{ item.item_name|linebreaksbr }}</span>
                </li>
                {% endfor %}
            </ul>

            <div class="order-total">
                Total: R$ {{ order.final_total|floatformat:2 }}
            </div>

            <div style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
                Pagamento: <strong>{{ order.get_payment_method_display }}</strong>
                {% if order.change_for %} (Troco p/ R$ {{ order.change_for|floatformat:2 }}){% endif %}
            </div>

            <div class="actions">
                <a href="https://wa.me/55{{ order.customer_whatsapp|cut:' '|cut:'-'|cut:'('|cut:')' }}?text=Pedido %23{{ order.id }} Recebido!%0A------------------------------%0ACliente: {{ order.customer_name|urlencode }}%0ATelefone: {{ order.customer_whatsapp }}%0AEndere√ßo: {{ order.delivery_address|urlencode }} - {{ order.delivery_zone.neighborhood|urlencode }}%0A------------------------------%0AItens:%0A{% for item in order.items.all %}{{ item.quantity }}x {{ item.item_name|urlencode }}%0A{% endfor %}{% if order.observations %}Obs: {{ order.observations|urlencode }}%0A{% endif %}------------------------------%0ATaxa Entrega: R$ {{ order.delivery_fee|floatformat:2 }}%0ATotal: R$ {{ order.final_total|floatformat:2 }}%0APagamento: {{ order.get_payment_method_display }}{% if order.change_for %} (Troco para {{ order.change_for|floatformat:2 }}){% endif %}%0A%0AAssim que o motoboy sair lhe avisaremos por aqui."
                    target="_blank" class="btn btn-whatsapp" title="Confirmar Pedido">
                    <span class="material-icons">chat</span>
                </a>
                <button onclick="printOrder('{{ order.id }}')" class="btn btn-print" title="Imprimir">
                    <span class="material-icons">print</span>
                </button>
                <a href="https://wa.me/55{{ order.customer_whatsapp|cut:' '|cut:'-'|cut:'('|cut:')' }}?text=Ol√° {{ order.customer_name }}, seu pedido %23{{ order.id }} saiu para entrega! üõµ%0APor favor, fique no aguardo."
                    target="_blank" class="btn btn-delivery" title="Avisar Entrega">
                    <span class="material-icons">two_wheeler</span>
                </a>
                <form method="post" action="{% url 'delivery:delete_order' order.id %}"
                    onsubmit="return confirm('Tem certeza que deseja excluir este pedido?');"
                    style="flex: 1; display: flex;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-delete" title="Excluir Pedido">
                        <span class="material-icons">delete</span>
                    </button>
                </form>
            </div>

            <!-- Modelo do Cupom Fiscal (Oculto) -->
            <div id="ticket-{{ order.id }}" class="printable-ticket">
                <div class="ticket-content">
                    <center>
                        <h3 style="margin: 0;">{{ order.tenant.name }}</h3>
                        <p style="margin: 5px 0;">Pedido #{{ order.id }}</p>
                        <p style="font-size: 16px;">{{ order.created_at|date:"d/m/Y H:i" }}</p>
                    </center>
                    <hr style="border-top: 1px dashed #000;">
                    <p><strong>Cliente:</strong> {{ order.customer_name }}</p>
                    <p><strong>Tel:</strong> {{ order.customer_whatsapp }}</p>
                    <p><strong>End:</strong> {{ order.delivery_address }}</p>
                    <p><strong>Bairro:</strong> {{ order.delivery_zone.neighborhood }}</p>
                    {% if order.observations %}<p><strong>Obs:</strong> {{ order.observations }}</p>{% endif %}
                    <hr style="border-top: 1px dashed #000;">
                    <table style="width: 100%; text-align: left;">
                        {% for item in order.items.all %}
                        <tr>
                            <td style="vertical-align: top;"><b>{{ item.quantity }}x</b></td>
                            <td><b>{{ item.item_name|linebreaksbr }}</b></td>
                            <td style="text-align: right;"><b>{{ item.price|floatformat:2 }}</b></td>
                        </tr>
                        {% endfor %}
                    </table>
                    <hr style="border-top: 1px dashed #000;">
                    <p style="display: flex; justify-content: space-between;">
                        <span>Entrega:</span>
                        <span>R$ {{ order.delivery_fee|floatformat:2 }}</span>
                    </p>
                    <p style="display: flex; justify-content: space-between; font-weight: 900; font-size: 24px;">
                        <span>TOTAL:</span> <span>R$ {{ order.final_total|floatformat:2 }}</span>
                    </p>
                    <p>
                    Pagamento: {{ order.get_payment_method_display }}
                    {% if order.change_for %}
                    (Troco p/ R$ {{ order.change_for|floatformat:2 }})
                    {% endif %}
                    </p>
                    <center>
                        <p style="margin-top: 10px;">Obrigado pela prefer√™ncia!</p>
                    </center>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    function printOrder(orderId) {
        const content = document.getElementById('ticket-' + orderId).innerHTML;
        const win = window.open('', '_blank');

        win.document.write('<html><head><title>Imprimir Pedido #' + orderId + '</title>');
        win.document.write('<style>');
        win.document.write('@page { size: 80mm auto; margin: 0; }');
        win.document.write('body { width: 80mm; margin: 0; padding: 5px; font-family: "Courier New", monospace; font-size: 22px; color: #000; font-weight: 900; }');
        win.document.write('h3 { font-weight: 900; font-size: 26px; }');
        win.document.write('strong, b { font-weight: 900; }');
        win.document.write('</style>');
        win.document.write('</head><body>');
        win.document.write(content);
        win.document.write('</body></html>');
        win.document.close();
        win.focus();
        setTimeout(() => { win.print(); win.close(); }, 250);
    }
</script>
{{ latest_order_id|json_script:"latest-order-id" }}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // ===== Obt√©m ID do √∫ltimo pedido de forma segura =====
    let currentLatestId = JSON.parse(
        document.getElementById('latest-order-id').textContent
    );

    const checkUrl = "{% url 'delivery:get_latest_order_id' %}";
    const notificationSound = new Audio("{% static 'sounds/aviso.mp3' %}");

    const ordersContainer = document.getElementById('orders-container');

    // ===== Remove destaque ao clicar =====
    if (ordersContainer) {
        ordersContainer.addEventListener('click', function (e) {
            const card = e.target.closest('.order-card');

            if (card && card.classList.contains('new-order')) {
                if (e.target.closest('a') || e.target.closest('button')) {
                    card.classList.remove('new-order');
                }
            }
        });
    }

    // ===== Fun√ß√£o para atualizar pedidos =====
    function updateOrders(oldLatestId) {

        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const newContent = doc.getElementById('orders-container');

                if (!newContent || !ordersContainer) return;

                ordersContainer.innerHTML = newContent.innerHTML;

                // ===== Destaca pedidos novos =====
                const cards = document.querySelectorAll('.order-card');

                cards.forEach(card => {
                    const orderId = parseInt(card.dataset.orderId);

                    if (orderId > oldLatestId) {
                        card.classList.add('new-order');
                    }
                });

            })
            .catch(error => console.error('Erro ao atualizar lista:', error));
    }

    // ===== Verifica novos pedidos =====
    function checkNewOrders() {

        fetch(checkUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao consultar pedidos');
                }
                return response.json();
            })
            .then(data => {

                if (data.latest_id > currentLatestId) {

                    const oldLatestId = currentLatestId;
                    currentLatestId = data.latest_id;

                    console.log("Novo pedido:", data.latest_id);

                    notificationSound.play().catch(() => {});

                    updateOrders(oldLatestId);
                }
            })
            .catch(error => console.error('Erro ao verificar pedidos:', error));
    }

    // ===== Executa verifica√ß√£o a cada 5 segundos =====
    setInterval(checkNewOrders, 5000);

});
</script>
{% endblock %}