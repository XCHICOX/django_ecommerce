{% extends 'base.html' %}

{% block title %}Relat√≥rios - {{ tenant.name }}{% endblock %}

{% block content %}
<!-- Campo CSRF necess√°rio para requisi√ß√µes AJAX -->
{% csrf_token %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .report-container {
        max-width: 1400px;
    }

    .filter-card {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .filter-form {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .filter-form input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .filter-form button {
        padding: 8px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        text-align: center;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #28a745;
        margin: 10px 0;
    }

    .chart-container {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        height: 400px;
    }

    .comandas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .comanda-card {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
    }

    .comanda-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .comanda-id {
        font-weight: 700;
        font-size: 1.1rem;
        color: #333;
    }

    .comanda-data {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .item-list {
        list-style: none;
        padding: 0;
        margin: 0 0 15px 0;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .item-list li {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.95rem;
    }

    .comanda-total {
        font-weight: 700;
        font-size: 1.1rem;
        text-align: right;
        color: #28a745;
        margin-bottom: 15px;
    }

    .actions {
        display: flex;
        gap: 10px;
        margin-top: auto;
    }

    .btn {
        flex: 1;
        padding: 10px;
        text-align: center;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
        border: none;
        font-size: 0.9rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
    }

    .btn-print {
        background-color: #333;
        color: white;
    }

    .btn-delete {
        background-color: #dc3545;
        color: white;
    }

    /* Modal de senha */
    .senha-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .senha-modal-content {
        background-color: white;
        padding: 25px;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        text-align: center;
    }

    .senha-input {
        width: 80%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 4px;
        margin: 15px 0;
    }
</style>

<div class="report-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">Relat√≥rio do Bar</h2>
    </div>

    <div class="filter-card">
        <span>Filtrar por per√≠odo:</span>
        <form method="get" class="filter-form">
            <input type="date" name="start_date" value="{{ start_date }}" required>
            <span>at√©</span>
            <input type="date" name="end_date" value="{{ end_date }}" required>
            <button type="submit">Filtrar</button>
        </form>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Vendido</h3>
            <div class="stat-value">R$ {{ total_sales|floatformat:2 }}</div>
            <p>No per√≠odo selecionado</p>
        </div>
        <div class="stat-card">
            <h3>Total de Comandas</h3>
            <div class="stat-value" style="color: #007bff;">{{ total_orders }}</div>
            <p>Comandas fechadas</p>
        </div>
    </div>

    <h3>Lista de Comandas</h3>
    <div class="comandas-grid">
        {% for comanda in comandas_fechadas %}
        <div class="comanda-card" id="comanda-{{ comanda.id }}">
            <div class="comanda-header">
                <span class="comanda-id">Mesa {{ comanda.numero_mesa }}</span>
                <span class="comanda-data">{{ comanda.data_fechamento|date:"d/m H:i" }}</span>
            </div>

            <ul class="item-list">
                {% for item in comanda.itens.all %}
                <li>
                    <span>{{ item.quantidade }}x {{ item.item.name }}</span>
                    <span>R$ {{ item.subtotal|floatformat:2 }}</span>
                </li>
                {% if item.observacao %}
                <li style="font-size: 0.8rem; color: #6c757d; border-bottom: none;">
                    Obs: {{ item.observacao }}
                </li>
                {% endif %}
                {% endfor %}
            </ul>

            <div class="comanda-total">
                Total: R$ {{ comanda.total|floatformat:2 }}
            </div>

            {% if comanda.gorjeta_10 %}
            <div style="font-size: 0.85rem; color: #666; margin-bottom: 15px; text-align: right;">
                (Inclui 10% de taxa de servi√ßo)
            </div>
            {% endif %}

            <div class="actions">
                <button onclick="imprimirComanda({{ comanda.id }})" class="btn btn-print">
                    <span class="material-icons">print</span> Imprimir
                </button>
                <button onclick="excluirComanda({{ comanda.id }}, {{ comanda.numero_mesa }})" class="btn btn-delete">
                    <span class="material-icons">delete</span> Excluir
                </button>
            </div>
        </div>
        {% empty %}
        <div style="grid-column: 1 / -1; padding: 40px; text-align: center; background: #fff; border-radius: 8px;">
            <p>Nenhuma comanda encontrada neste per√≠odo.</p>
        </div>
        {% endfor %}
    </div>

    <div class="chart-container" style="margin-top: 40px;">
        <h3 style="margin-top: 0; margin-bottom: 20px;">Evolu√ß√£o de Vendas</h3>
        <canvas id="salesChart"></canvas>
    </div>
</div>

<script>
    const ctx = document.getElementById('salesChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ dates_json| safe }},
        datasets: [{
            label: 'Vendas do Bar (R$)',
            data: {{ values_json| safe }},
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        borderColor: 'rgba(0, 123, 255, 1)',
        borderWidth: 2,
        fill: true,
        tension: 0.3
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function (value) { return 'R$ ' + value; }
                }
            }
        }
    }
    });
</script>

<!-- Modal para senha de exclus√£o -->
<div id="senhaModal" class="senha-modal" style="display: none;">
    <div class="senha-modal-content">
        <h3>üîí Confirma√ß√£o de Exclus√£o</h3>
        <p>Digite sua senha para confirmar a exclus√£o da comanda da <strong>Mesa <span
                    id="modal-mesa-numero"></span></strong>:</p>
        <input type="password" id="senhaInput" class="senha-input" placeholder="Digite sua senha">
        <div class="senha-buttons">
            <button class="btn-modal btn-cancelar" onclick="fecharModalSenha()"
                style="padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; background-color: #6c757d; color: white;">Cancelar</button>
            <button class="btn-modal btn-confirmar" onclick="confirmarExclusao()"
                style="padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; background-color: #dc3545; color: white;">Confirmar
                Exclus√£o</button>
        </div>
    </div>
</div>

<script>
    let comandaParaExcluir = null;

    function imprimirComanda(comandaId) {
        console.log('Fun√ß√£o imprimirComanda chamada com comanda ID:', comandaId);
        // Abrir em nova janela para impress√£o
        window.open('/bar/reimprimir-comanda/' + comandaId + '/', '_blank', 'width=400,height=600');
    }

    function excluirComanda(comandaId, numeroMesa) {
        try {
            console.log('=== EXCLUIR COMANDA CHAMADA ===');
            console.log('Comanda ID:', comandaId, 'Mesa:', numeroMesa);

            comandaParaExcluir = {
                id: comandaId,
                numeroMesa: numeroMesa
            };

            const mesaSpan = document.getElementById('modal-mesa-numero');
            if (mesaSpan) mesaSpan.textContent = numeroMesa;

            const modal = document.getElementById('senhaModal');
            if (modal) {
                modal.style.display = 'flex';
                const senhaInput = document.getElementById('senhaInput');
                if (senhaInput) senhaInput.focus();
            }
        } catch (error) {
            console.error('Erro na fun√ß√£o excluirComanda:', error);
            alert('Erro ao tentar excluir comanda: ' + error.message);
        }
    }

    function fecharModalSenha() {
        document.getElementById('senhaModal').style.display = 'none';
        comandaParaExcluir = null;
    }

    function confirmarExclusao() {
        const senha = document.getElementById('senhaInput').value;
        if (!senha) {
            alert('Por favor, digite sua senha.');
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const formData = new FormData();
        formData.append('senha', senha);

        fetch('/bar/excluir-comanda/' + comandaParaExcluir.id + '/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': csrfToken }
        })
            .then(response => response.json().then(data => {
                if (!response.ok) throw new Error(data.error || 'Erro no servidor');
                return data;
            }))
            .then(data => {
                alert(data.message);
                location.reload();
            })
            .catch(error => {
                alert(error.message);
                document.getElementById('senhaInput').value = '';
            });
    }

    // Modal Events
    document.getElementById('senhaModal').addEventListener('click', function (e) {
        if (e.target === this) fecharModalSenha();
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && document.getElementById('senhaModal').style.display === 'flex') fecharModalSenha();
        if (e.key === 'Enter' && document.getElementById('senhaModal').style.display === 'flex') confirmarExclusao();
    });
</script>
{% endblock %}